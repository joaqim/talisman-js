var talisman=talisman||{};talisman.creatures=[{name:"wolf",type:"animal",strength:4,wisdom:0},{name:"storm_caller",type:"cultist",strength:4,wisdom:0,conditional:{target:"player",if:{has_armour:!0},do:{lose_life:1}}}],talisman.modifiers=[{name:"always_one_spell",callbacks:{update:{conditional:{target:"this",if:{less_than_or_eq:["spell_count",0]},do:{draw_spell:1}}}}}],talisman.talisman_board={1:{name:"city",neighbours:[2,24],conditional:{use_raft:[25]},center:{x:410,y:270},col:1,row:1},2:{name:"fields",neighbours:[1,3],conditional:{use_raft:[25,26]},center:{x:1e3,y:270},col:2,row:1},3:{name:"hills",neighbours:[2,4],conditional:{use_raft:[26,27]},center:{x:1650,y:270},col:3,row:1},4:{name:"plains",neighbours:[3,5],conditional:{use_raft:[27]},center:{x:2300,y:270},col:4,row:1},5:{name:"woods",neighbours:[4,6],conditional:{use_raft:[27,28]},center:{x:2930,y:270},col:5,row:1},6:{name:"plains",neighbours:[5,7],conditional:{use_raft:[28,29]},center:{x:3580,y:270},col:6,row:1},7:{name:"tavern",neighbours:[6,8],conditional:{use_raft:[29]},center:{x:4275,y:285},col:7,row:1},8:{name:"fields",neighbours:[7,9],conditional:{use_raft:[29]},center:{x:4275,y:660},col:7,row:2},9:{name:"runes",neighbours:[8,10],conditional:{use_raft:[29,30,31]},center:{x:4275,y:1170},col:7,row:3},10:{name:"plains",neighbours:[9,11],conditional:{use_raft:[31,32]},center:{x:4275,y:1640},col:7,row:4},11:{name:"forest",neighbours:[10,12],conditional:{use_raft:[32,33]},center:{x:4275,y:1980},col:7,row:5},12:{name:"fields",neighbours:[11,13],conditional:{use_raft:[33]},center:{x:4275,y:2350},col:7,row:6},13:{name:"village",neighbours:[12,14],conditional:{use_raft:[33]},center:{x:4200,y:2750},col:7,row:7},14:{name:"fields",neighbours:[13,15],conditional:{use_raft:[33,34]},center:{x:3575,y:2760},col:6,row:7},15:{name:"graveyard",neighbours:[14,16],conditional:{use_raft:[34,35]},center:{x:2925,y:2760},col:5,row:7},16:{name:"woods",neighbours:[15,17],conditional:{use_raft:[35]},center:{x:2255,y:2760},col:4,row:7},17:{name:"sentinel",neighbours:[16,18],conditional:{defeat_sentinel:36,use_raft:[36,35]},center:{x:1650,y:2760},col:3,row:7},18:{name:"hills",neighbours:[17,19],conditional:{use_raft:[36,37]},center:{x:1e3,y:2760},col:2,row:7},19:{name:"chapel",neighbours:[18,20],conditional:{use_raft:[37]},center:{x:405,y:2740},col:1,row:7},20:{name:"fields",neighbours:[19,21],conditional:{use_raft:[37]},center:{x:310,y:2355},col:1,row:6},21:{name:"crags",neighbours:[20,22],conditional:{use_raft:[37,38]},center:{x:310,y:1940},col:1,row:5},22:{name:"plains",neighbours:[21,23],conditional:{use_raft:[39,40]},center:{x:310,y:1535},col:1,row:4},23:{name:"woods",neighbours:[22,24],conditional:{use_raft:[40,25]},center:{x:310,y:1110},col:1,row:3},24:{name:"fields",neighbours:[23,1],conditional:{use_raft:[25]},center:{x:310,y:700},col:1,row:2},25:{name:"warlock's cave",neighbours:[26,40],conditional:{use_raft:[1,2,24]},center:{x:900,y:710},col:2,row:2},26:{name:"desert",neighbours:[25,26],conditional:{use_raft:[2,3]},center:{x:1550,y:710},col:3,row:2},27:{name:"oasis",neighbours:[26,28],conditional:{use_raft:[3,4,5]},center:{x:2300,y:710},col:4,row:2},28:{name:"desert",neighbours:[27,29],conditional:{use_raft:[5,6]},center:{x:3060,y:710},col:5,row:2},29:{name:"temple",neighbours:[28,30],conditional:{use_raft:[6,7,8,9]},center:{x:3760,y:750},col:6,row:2},30:{name:"woods",neighbours:[29,31],conditional:{use_raft:[9]},center:{x:3830,y:1135},col:6,row:3},31:{name:"runes",neighbours:[30,32],conditional:{use_raft:[9,10]},center:{x:3830,y:1545},col:6,row:4},32:{name:"castle",neighbours:[31,33],conditional:{use_raft:[10,11]},center:{x:3830,y:1920},col:6,row:5},33:{name:"portal_of_power",neighbours:[32,34],conditional:{portal_of_power:[48],use_raft:[12,13,14]},center:{x:3680,y:2310},col:6,row:6},34:{name:"black_knight",neighbours:[33,35],conditional:{use_raft:[14,15]},center:{x:3020,y:2300},col:5,row:6},35:{name:"hidden_valley",neighbours:[34,36],conditional:{use_raft:[15,16,17]},center:{x:2300,y:2300},col:4,row:6},36:{name:"hills",neighbours:[35,37],conditional:{use_raft:[17,18]},center:{x:1530,y:2300},col:3,row:6},37:{name:"cursed_glade",neighbours:[36,38],conditional:{use_raft:[18,19,20]},center:{x:840,y:2290},col:2,row:6},38:{name:"runes",neighbours:[37,39],conditional:{use_raft:[21]},center:{x:780,y:1920},col:2,row:5},39:{name:"chasm",neighbours:[38,40],conditional:{use_raft:[22]},center:{x:780,y:1545},col:2,row:4},40:{name:"runes",neighbours:[39,25],conditional:{use_raft:[22,23]},center:{x:780,y:1135},col:2,row:3},41:{name:"plain_of_peril",neighbours:[33,45,46],center:{x:3150,y:1900},col:5,row:5},42:{name:"mines",neighbours:[41,43],center:{x:2335,y:1900},col:4,row:5},43:{name:"vampire's tower",neighbours:[42,44],center:{x:1420,y:1900},col:3,row:5},44:{name:"pits",neighbours:[43],conditional:{has_talisman:[48]},center:{x:1310,y:1510},col:3,row:4},45:{name:"crypt",neighbours:[41,46],center:{x:3390,y:1520},col:5,row:4},46:{name:"dice_with_death",neighbours:[45,47],center:{x:3165,y:1140},col:5,row:3},47:{name:"werewolf_den",neighbours:[46,48],center:{x:2335,y:1135},col:4,row:3},48:{name:"valley of fire",neighbours:[44,47,49],center:{x:1420,y:1140},col:3,row:3},49:{name:"crown_of_command",neighbours:[48],center:{x:2330,y:1515},col:4,row:4}};class Atom{constructor(){}init(t){this.onInit(t)}update(t){this.onUpdate(t)}onInit(t){}onUpdate(t){}}class BaseEntity extends Atom{constructor(t,e,n,i,r=[],o=[]){super(),this.state={name:t,real_name:e,type:n,category:i};for(let t in r)r[t](this,o[t])}}class Entity extends BaseEntity{constructor(t,e,n,i,r=[],o=[]){super(t,e,n,i,r,o)}canHold(){return!0}canUse(){return!0}use(){return this.onUse(),!0}added(t){return this.onAdded(t),!0}removed(t){return this.onRemoved(t)}used(t,e=null){return this.onUsed(t,e),{val:!0}}canDrop(t){return this.onCanDrop()}onCanDrop(){return!0}onAdded(t){return{val:!0}}onRemoved(t){return!0}onUse(t,e){return!0}reqUse(t,e=null){return this.onReqUse(t,e)}reqAdd(t){return this.onReqAdd(t)}onReqUse(t,e=null){return{val:!0}}onReqUse(t){return{val:!0}}}class Character extends Entity{constructor(t,e,n,i,r,o,a=new Map,s=new Map,l=new Map,c=new Array){super(),this.state={name:t,health:e,strength:n,craft:i,fate:r,gold:o,carryLimit:4,items:a,followers:s,spells:l,trophys:c},this.changes={lives:0,strength:0,craft:0,fate:0}}get(t){}add(t){this.state[t.state.type+"s"]}remove(t){}addEntity(t){this.state[t.state.type+"s"][t.state.name]=t,t.added(this),console.log(`${this.state.name} added ${t.state.type}:  ${t.state.name}`)}discardEntity(t,e){let n=this.state[e+"s"];n[t].removed(this),n.delete(t)}dropEntity(t,e){let n=this.state[e+"s"],i=n[t].canDrop(this);if(0==i.val)return i;n[t].removed(this);let r=Object.create(n[t]);return n.delete(t),{val:r}}useEntity(t,e,n=null){return this.state[e+"s"][t].use(this,n)}canUse(t,e,n=null){return this.state[e+"s"][t].reqUse(this,n)}drawCard(t){t={game:t.game,deck:t.deck?t.deck:"adventure",amount:t.amount?t.amount:1},this.onDrawCard(t)}onDrawCard(){}battleWon(t){this.onBattleWon(t)}onBattleWon(t){console.log(t),"creature"==t.state.type&&t.defeated(this)}addTrophy(t){console.log(`${this.state.name} gained a trophy: ${t.state.real_name} with ${t.value.value+" "+t.value.type} .`),this.state.trophys.push(t)}useSpell(){this.onUseSpell()}addSpell(t){this.state.spells[t.name]=t}hasMaxSpells(){return this.spellCount()<this.maxSpells()}maxSpells(){return Math.min(0,Math.floor(this.state.craft/2))}spellCount(){return this.state.spells.size}}function add_mod(t,e,n,i=!1){let r=t[e].bind(t);t[e]=t=>{n(t),i||r()}}function add_mod2(t,e){let n=t[e.when].bind(t);t[e.when]=t=>{0==e.replace&&n(),e.callback(t)}}function add_mod2_cond(t,e){let n=t[e.when].bind(t);t[e.when]=i=>{let r=e.callback(i);return n?r:{val:!1,txt:`${i.state.real_name} cannot use ${t.state.real_name}.`}}}function always_x_of_spells(t,e){add_mod2(t,{when:"onUpdate",callback:n=>{t.spellCount()<e.amount&&n.drawSpell(t,e.amount-t.spellCount())}})}function may_mulligan_cards(t,e){null==t.type?add_mod2(t,{when:"onDrawCard",callback:t=>{console.log(t.deck),t.deck==e.deck&&(game.turn.mulligans=Math.max(Math.min(t.amount,e.amount),game.turn.mulligans),console.log("Added mulligans ",game.turn.mulligans))},replace:!1}):(event={event:EVENT.DRAW_CARD,action:t=>{t.turn.mulligans=Math.max(t.turn.mulligans,1)}},PubSub.enable(t),t.subscribe(event.event,action.action))}function change_inventory_size(t,e=4){var n=document.getElementById("inventory").getElementsByTagName("tbody")[0];if(e>0)for(var i=document.createElement("tr"),r=t.state.carryLimit+1;r-1<t.state.carryLimit+e;r++){var o=document.createElement("td");o.id="i"+r,o.setAttribute("class","slot"),i.appendChild(o),r%4==0&&(n.appendChild(i),i=document.createElement("tr"))}else for(r=0;r<-e/4;r++)n.deleteRow(n.rows-r);t.state.carryLimit+=e}function carry_limit_increase(t,e){add_mod(t,"onAdded",t=>{change_inventory_size(t,e.change)}),add_mod(t,"onRemoved",t=>{change_inventory_size(t,-e.change)})}function discard_on_remove(t){add_mod2_cond(t,{when:"onRemoved",callback:()=>({val:!1,text:t.state.real_name+" was discarded."}),replace:!0}),cant_be_dropped(t)}function cant_be_dropped(t){add_mod2_cond(t,{when:"onCanDrop",callback:()=>({val:!1,text:t.state.real_name+" can't be dropped."}),replace:!0})}function required_alignment_to_use(t,e){add_mod2_cond(t,{when:"onReqUse",callback:(n,i)=>n.state.alignment===e.alignment!=(!1===e.NOT)?{val:!0,text:`${t.state.real_name} CAN be used by ${e.alignment} characters`}:{val:!1,text:`${t.state.real_name} can ONLY be used by ${e.alignment} characters`}})}function required_alignment_to_pickup(t,e,n=!1){}function weapon_lifesteal(t,e=1){add_mod2(t,"onBattleWon",(n,i)=>{"creature"==i.type?(console.log(`${t.state.real_name} was used to steal ${e} life from ${i.state.real_name}`),n.changes.lives=1):-1==i.changes&&(console.log(`${t.state.real_name} was used to steal ${e} life from ${i.state.name}`),n.changes.lives=1)})}const RuneSword=()=>new Entity("rune_sword","Rune sword","item","Magical Item",[required_alignment_to_use],[{alignment:"evil"}]),CrystalBall=()=>new Entity("crystal_ball","Crystal Ball","item","Magical Item"),spell_book=()=>new Entity("spell_book","magical_item",[always_one_spell]),rune_sword=()=>new Entity("rune_sword","magical_weapon",[required_alignment_to_use,weapon_lifesteal],[{alignment:"evil"},{amount:1}]),holy_grail=()=>new Entity("holy_grail","magical_item",[required_alignment_to_use],[{alignment:"good"}]),Mule=()=>new Entity("mule","Mule","follower","Animal",[carry_limit_increase],[{change:4}]),HorseAndCart=()=>new Entity("horse_and_cart","follower",[carry_limit_increase],[{change:8}]);class Prophetess extends Character{constructor(){super("Prophetess",2,4,4,2,"good"),always_x_of_spells(this,{amount:1}),may_mulligan_cards(this,{deck:"adventure",amount:1})}}class Creature extends BaseEntity{constructor(t,e,n,i,r,o,a=[],s=[]){super(t,e,n,i,a,s),this.value={type:r?"strength":"craft",value:r||o}}defeated(t){t.addTrophy(this),this.onDefeated(t)}onDefeated(t){}}const Wolf=()=>new Creature("wolf","Wolf","creature","Animal",2,0);function AssetsManager(t){return images={},{loadAssets:function(){return Array.from({length:t.assets.length},(e,i)=>n(t.assets[i].id,t.assets[i].src,{x:t.assets[i].width,y:t.assets[i].height}))},getImage:e,get:e,loadImage:n};function e(t){return t in images?images[t]:null}function n(t,e,n={x:null,y:null}){var i=new Image,r=new Promise(function(n,r){i.onload=function(){images[t]=i,n(i)}.bind(this),i.onerror=function(){r("Could not load image: "+e)}}.bind(this));return i.src=e,i.width=n.x,i.height=n.y,i.style=`width: ${n.x}px; height: ${n.y}px;`,r}}function BoardManager(){const t=talisman.talisman_board;return{getTile:e,draw:function(t){m=Math.pow(7,2);for(var i=1;i<m+1;i++)n(t,e(i))},test:function(){var e=1,n=1,i={x:1,y:0},r=7,o=1;const a=Math.pow(r,2);deviations=new Map([[40,{x:5,y:5,delta:{x:-1,y:0}}],[44,{x:5,y:4,delta:{x:0,y:-1}}],[46,{x:4,y:3,delta:{x:-1,y:0}}],[48,{x:4,y:4,delta:{x:0,y:0}}]]);let s={};for(var l=1;l<a+1;l++)console.log(e,n," : ",l),t[l].col=e,t[l].row=n,e+=i.x,n+=i.y,(s=deviations.get(l))?([e,n,i]=[s.x,s.y,s.delta],o++,r--):e==r&&n==o?i={x:0,y:1}:e==r&&n==r?i={x:-1,y:0}:e==o&&n==r?i={x:0,y:-1}:l==4*(r-o)&&(r--,o++,e++,n=o,i={x:1,y:0})},init:function(){}};function e(e){return t[e]}function n(t,e){t.beginPath(),tx=65.5,ty=43,t.rect((e.col-1)*tx,(e.row-1)*ty,tx,ty),t.stroke(),t.beginPath();let n=e.center;t.arc(n.x/10,n.y/10,5,0,2*Math.PI),t.fill(),x=e.x,y=e.y}}!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("StateMachine",[],e):"object"==typeof exports?exports.StateMachine=e():t.StateMachine=e()}(this,(function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.i=function(t){return t},n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:i})},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=5)}([function(t,e,n){"use strict";t.exports=function(t,e){var n,i,r;for(n=1;n<arguments.length;n++)for(r in i=arguments[n])i.hasOwnProperty(r)&&(t[r]=i[r]);return t}},function(t,e,n){"use strict";var i=n(0);t.exports={build:function(t,e){var n,r,o,a=e.plugins;for(n=0,r=a.length;n<r;n++)(o=a[n]).methods&&i(t,o.methods),o.properties&&Object.defineProperties(t,o.properties)},hook:function(t,e,n){var i,r,o,a,s=t.config.plugins,l=[t.context];for(n&&(l=l.concat(n)),i=0,r=s.length;i<r;i++)a=s[i],(o=s[i][e])&&o.apply(a,l)}}},function(t,e,n){"use strict";function i(t){if(0===t.length)return t;var e,n,i=t.split(/[_-]/);if(1===i.length&&i[0][0].toLowerCase()===i[0][0])return t;for(n=i[0].toLowerCase(),e=1;e<i.length;e++)n=n+i[e].charAt(0).toUpperCase()+i[e].substring(1).toLowerCase();return n}i.prepended=function(t,e){return t+(e=i(e))[0].toUpperCase()+e.substring(1)},t.exports=i},function(t,e,n){"use strict";var i=n(0),r=n(2);function o(t,e){t=t||{},this.options=t,this.defaults=e.defaults,this.states=[],this.transitions=[],this.map={},this.lifecycle=this.configureLifecycle(),this.init=this.configureInitTransition(t.init),this.data=this.configureData(t.data),this.methods=this.configureMethods(t.methods),this.map[this.defaults.wildcard]={},this.configureTransitions(t.transitions||[]),this.plugins=this.configurePlugins(t.plugins,e.plugin)}i(o.prototype,{addState:function(t){this.map[t]||(this.states.push(t),this.addStateLifecycleNames(t),this.map[t]={})},addStateLifecycleNames:function(t){this.lifecycle.onEnter[t]=r.prepended("onEnter",t),this.lifecycle.onLeave[t]=r.prepended("onLeave",t),this.lifecycle.on[t]=r.prepended("on",t)},addTransition:function(t){this.transitions.indexOf(t)<0&&(this.transitions.push(t),this.addTransitionLifecycleNames(t))},addTransitionLifecycleNames:function(t){this.lifecycle.onBefore[t]=r.prepended("onBefore",t),this.lifecycle.onAfter[t]=r.prepended("onAfter",t),this.lifecycle.on[t]=r.prepended("on",t)},mapTransition:function(t){var e=t.name,n=t.from,i=t.to;return this.addState(n),"function"!=typeof i&&this.addState(i),this.addTransition(e),this.map[n][e]=t,t},configureLifecycle:function(){return{onBefore:{transition:"onBeforeTransition"},onAfter:{transition:"onAfterTransition"},onEnter:{state:"onEnterState"},onLeave:{state:"onLeaveState"},on:{transition:"onTransition"}}},configureInitTransition:function(t){return"string"==typeof t?this.mapTransition(i({},this.defaults.init,{to:t,active:!0})):"object"==typeof t?this.mapTransition(i({},this.defaults.init,t,{active:!0})):(this.addState(this.defaults.init.from),this.defaults.init)},configureData:function(t){return"function"==typeof t?t:"object"==typeof t?function(){return t}:function(){return{}}},configureMethods:function(t){return t||{}},configurePlugins:function(t,e){var n,i,r;for(n=0,i=(t=t||[]).length;n<i;n++)"function"==typeof(r=t[n])&&(t[n]=r=r()),r.configure&&r.configure(this);return t},configureTransitions:function(t){var e,n,i,r,o,a=this.defaults.wildcard;for(n=0;n<t.length;n++)for(i=t[n],r=Array.isArray(i.from)?i.from:[i.from||a],o=i.to||a,e=0;e<r.length;e++)this.mapTransition({name:i.name,from:r[e],to:o})},transitionFor:function(t,e){var n=this.defaults.wildcard;return this.map[t][e]||this.map[n][e]},transitionsFor:function(t){var e=this.defaults.wildcard;return Object.keys(this.map[t]).concat(Object.keys(this.map[e]))},allStates:function(){return this.states},allTransitions:function(){return this.transitions}}),t.exports=o},function(t,e,n){var i=n(0),r=n(6),o=n(1),a=[null,[]];function s(t,e){this.context=t,this.config=e,this.state=e.init.from,this.observers=[t]}i(s.prototype,{init:function(t){if(i(this.context,this.config.data.apply(this.context,t)),o.hook(this,"init"),this.config.init.active)return this.fire(this.config.init.name,[])},is:function(t){return Array.isArray(t)?t.indexOf(this.state)>=0:this.state===t},isPending:function(){return this.pending},can:function(t){return!this.isPending()&&!!this.seek(t)},cannot:function(t){return!this.can(t)},allStates:function(){return this.config.allStates()},allTransitions:function(){return this.config.allTransitions()},transitions:function(){return this.config.transitionsFor(this.state)},seek:function(t,e){var n=this.config.defaults.wildcard,i=this.config.transitionFor(this.state,t),r=i&&i.to;return"function"==typeof r?r.apply(this.context,e):r===n?this.state:r},fire:function(t,e){return this.transit(t,this.state,this.seek(t,e),e)},transit:function(t,e,n,i){var r=this.config.lifecycle,o=this.config.options.observeUnchangedState||e!==n;return n?this.isPending()?this.context.onPendingTransition(t,e,n):(this.config.addState(n),this.beginTransit(),i.unshift({transition:t,from:e,to:n,fsm:this.context}),this.observeEvents([this.observersForEvent(r.onBefore.transition),this.observersForEvent(r.onBefore[t]),o?this.observersForEvent(r.onLeave.state):a,o?this.observersForEvent(r.onLeave[e]):a,this.observersForEvent(r.on.transition),o?["doTransit",[this]]:a,o?this.observersForEvent(r.onEnter.state):a,o?this.observersForEvent(r.onEnter[n]):a,o?this.observersForEvent(r.on[n]):a,this.observersForEvent(r.onAfter.transition),this.observersForEvent(r.onAfter[t]),this.observersForEvent(r.on[t])],i)):this.context.onInvalidTransition(t,e,n)},beginTransit:function(){this.pending=!0},endTransit:function(t){return this.pending=!1,t},failTransit:function(t){throw this.pending=!1,t},doTransit:function(t){this.state=t.to},observe:function(t){if(2===t.length){var e={};e[t[0]]=t[1],this.observers.push(e)}else this.observers.push(t[0])},observersForEvent:function(t){for(var e,n=0,i=this.observers.length,r=[];n<i;n++)(e=this.observers[n])[t]&&r.push(e);return[t,r,!0]},observeEvents:function(t,e,n,i){if(0===t.length)return this.endTransit(void 0===i||i);var r=t[0][0],a=t[0][1],s=t[0][2];if(e[0].event=r,r&&s&&r!==n&&o.hook(this,"lifecycle",e),0===a.length)return t.shift(),this.observeEvents(t,e,r,i);var l=a.shift(),c=l[r].apply(l,e);return c&&"function"==typeof c.then?c.then(this.observeEvents.bind(this,t,e,r)).catch(this.failTransit.bind(this)):!1===c?this.endTransit(!1):this.observeEvents(t,e,r,c)},onInvalidTransition:function(t,e,n){throw new r("transition is invalid in current state",t,e,n,this.state)},onPendingTransition:function(t,e,n){throw new r("transition is invalid while previous transition is still in progress",t,e,n,this.state)}}),t.exports=s},function(t,e,n){"use strict";var i=n(0),r=n(2),o=n(1),a=n(3),s=n(4),l={is:function(t){return this._fsm.is(t)},can:function(t){return this._fsm.can(t)},cannot:function(t){return this._fsm.cannot(t)},observe:function(){return this._fsm.observe(arguments)},transitions:function(){return this._fsm.transitions()},allTransitions:function(){return this._fsm.allTransitions()},allStates:function(){return this._fsm.allStates()},onInvalidTransition:function(t,e,n){return this._fsm.onInvalidTransition(t,e,n)},onPendingTransition:function(t,e,n){return this._fsm.onPendingTransition(t,e,n)}},c={state:{configurable:!1,enumerable:!0,get:function(){return this._fsm.state},set:function(t){throw Error("use transitions to change state")}}};function u(t){return h(this||{},t)}function h(t,e){return d(t,new a(e,u)),t._fsm(),t}function d(t,e){if("object"!=typeof t||Array.isArray(t))throw Error("StateMachine can only be applied to objects");o.build(t,e),Object.defineProperties(t,c),i(t,l),i(t,e.methods),e.allTransitions().forEach((function(e){t[r(e)]=function(){return this._fsm.fire(e,[].slice.call(arguments))}})),t._fsm=function(){this._fsm=new s(this,e),this._fsm.init(arguments)}}u.version="3.0.1",u.factory=function(){var t,e;"function"==typeof arguments[0]?(t=arguments[0],e=arguments[1]||{}):(t=function(){this._fsm.apply(this,arguments)},e=arguments[0]||{});var n=new a(e,u);return d(t.prototype,n),t.prototype._fsm.config=n,t},u.apply=h,u.defaults={wildcard:"*",init:{name:"init",from:"none"}},t.exports=u},function(t,e,n){"use strict";t.exports=function(t,e,n,i,r){this.message=t,this.transition=e,this.from=n,this.to=i,this.current=r}}])})),EVENT={CREATURE_DEFEATED:0,CREATURE_KILLED:1,CREATURE_STALEMATE:2,PLAYER_DEFATED:3,PLAYER_KILLED:4,PLAYER_STALEMATE:5,SPELL_CAST:6};var cfg={state:{init:"init",transitions:[{name:"startTurn",from:["init","end_turn"],to:"start_turn"},{name:"movement",from:["entity_effect","card_effect","tile_effect","spell_effect","dice_result","start_turn","use_entity"],to:"move"},{name:"last_turn",from:["battle_won","encounter_end"],to:"end_turn"},{name:"diceResult",from:"roll_dice",to:"dice_result"},{name:"useFate",from:["roll_dice"],to:"dice_result"},{name:"useEntity",from:["start_turn","roll_dice","encounter"],to:"use_entity"},{name:"encounter",from:"move",to:"encounter"},{name:"encounterTile",from:["encounter","defeat_creature","evade_creature","movement"],to:"tile_effect"},{name:"encounterDrawTile",from:"encounter",to:"encounter_draw_tile"},{name:"encounterCharacter",from:"encounter",to:"encounter_character"},{name:"engageBattle",from:["encounter_character","encounter_creature","card_effect","tile_effect","spell_effect"],to:"engage_battle"},{name:"battleLost",from:"engage_battle",to:"battle_lost"},{name:"battleWon",from:"engage_battle",to:"battle_won"},{name:"battleStalemate",from:"engage_battle",to:"end_turn"},{name:"specialAbility",from:["encounter","encounter_character","encounter_creature","encounter_card","engage_creature","engage_character","roll_dice"]},{name:"applyChanges",from:"encounter_end"},{name:"missTurn",from:["start_turn","tile_effect","spell_effect","card_effect"],to:"end_turn"},{name:"drawCard",from:["encounter_draw_tile","card_effect","tile_effect"],to:"draw_card"},{name:"mulliganCard",from:"draw_card",to:"mulligan_card"},{name:"encounterCard",from:["encounter","tile_effect","encounter_draw_tile","draw_card"],to:"card_effect"},{name:"rollDice",from:["start_turn","entity_effect","card_effect","tile_effect","spell_effect","movement"],to:"roll_dice"},{name:"endTurn",from:["encounter_end","battle_stalemate","battle_end"]}],methods:{onInit:function(){return console.log("Init"),!1},onStartTurn:function(){return console.log("onStartTurn"),!1},onRollDice:function(){},onMove:function(){},onEndTurn:function(){},onUseItem:function(){}}},events:[{event:EVENT.CREATURE_DEFEATED,action:function(t,e){this.onCreatureWon(t,e)}},{event:EVENT.CREATURE_KILLED,action:function(t,e){this.onCreatureKilled(t,e)}},{event:EVENT.CREATURE_STALEMATE,action:function(t,e){this.onCreatureStalemate(t,e)}},{event:EVENT.PLAYER_DEFEATED,action:function(t,e){this.onPlayerDefeated(character,e)}},{event:EVENT.PLAYER_KILLED,action:function(t,e){this.onPlayerKilled(character,e)}},{event:EVENT.PLAYER_STALEMATE,action:function(t,e){this.onPlayerStalemate(character,e)}},{event:EVENT.SPELL_CAST,action:function(t,e,n=null){this.onSpellCast(t,e,n)}},{event:EVENT.ENTITY_USED,action:function(t,e,n=null){this.onEntityUsed(t,e,n)}},{event:EVENT.ROLL_DIE,action:function(t){this.onRollDie(t)}},{event:EVENT.PLAYER_ROLL_DIE,action:function(t){this.onPlayerRollDie(t)}},{event:EVENT.PLAYER_DICE_RESULT,action:function(t){this.onPlayerRollDie(t)}},{event:EVENT.PLAYER_MOVE,action:function(t){this.onPlayerMove(t)}},{event:EVENT.PLAYER_DRAW_CARD,action:function(t){this.onPlayerDrawCard(t)}},{event:EVENT.PLAYER_DRAW_SPELL,action:function(t){this.onPlayerDrawSpell(t)}}],assets:[{id:"board",src:"assets/talisman_board_hr.jpg",width:4581,height:3026},{id:"prophetess",src:"assets/prophetess.png",width:120,height:120},{id:"100x100",src:"assets/100x100.png",width:100,height:100}]};PubSub={enable:function(t){t.subscribe=function(t,e){this.subscribers=this.subscribers||{},this.subscribers[t]=this.subscribers[t]||[],this.subscribers[t].push(e)},t.publish=function(e){if(console.log(e),this.subscribers&&this.subscribers[e]){var n,i,r=this.subscribers[e],o=[].slice.call(arguments,1);for(n=0,i=r.length;n<i;n++)r[n].apply(t,o)}}}},p=new Prophetess;class GameState extends StateMachine{turn={mulligans:0};players=[p];player=p;ctx=document.getElementById("canvas").getContext("2d");am=new AssetsManager(cfg);constructor(t){super(t.state),PubSub.enable(this);for(let e in t.events)this.subscribe(e,t.events[e].action)}testTurns(){console.log(this.allStates()),console.log(this.transitions());let t=["startTurn","useEntity","movement","encounter","encounterCharacter","engageBattle","battleWon","lastTurn"];for(let e in t)console.log(this.transitions()),this[t[e]](),console.log(this.state)}testPlayer(){this.startTurn(),this.player.update(this),this.player.addEntity(new Entity("rune_sword","Rune sword","item","Magical Item",[required_alignment_to_use],[{alignment:"evil"}]));let t=this.player.canUse("rune_sword","item");console.log(t.val,t.text);let e=this.player.dropEntity("rune_sword","item");0==e.val&&console.log(e.text),this.player.addEntity((this.player,new Entity("crystal_ball","Crystal Ball","item","Magical Item"))),this.player.drawCard({game:this,deck:"adventure",amount:1})}testBattle(){this.player.battleWon(new Creature("wolf","Wolf","creature","Animal",2,0)),console.log(this.player.state.trophies)}drawSpell(t,e){t.hasMaxSpells()||(console.log(`${t.state.name} draws ${e} spell(s)`),t.addSpell({name:"random"}))}drawImage(t,e,n,i={}){const r=this.am.get(t);i.x?this.ctx.drawImage(r,e,n,i.x,i.y):i.scale?this.ctx.drawImage(r,e,n,r.width*i.scale,r.height*i.scale):this.ctx.drawImage(r,e,n)}start(){console.log(),this.drawImage("board",0,0,{scale:.2})}}window.onload=function(){game=new Game,game.start()};class Game{constructor(){this.boardEl=document.getElementById("board-wrapper"),this.ctx=document.getElementById("board").getContext("2d"),this.asm=new AssetsManager(cfg),this.width=969,this.height=640,this.dirty_frames=[{x:0,y:0,width:this.width,height:this.height}],this.mousedown=!1}initMouseMove(t){this.mousedown=!0,this.mx=t.clientX,this.my=t.clientY}rotate(t,e,n,i){var r=Math.cos(n),o=Math.sin(n),a=Math.cos(i),s=Math.sin(i),l=t.x-e.x,c=t.y-e.y,u=t.z-e.z;t.x=r*l-o*a*c+o*s*u+e.x,t.y=o*l+r*a*c-r*s*u+e.y,t.z=s*c+a*u+e.z}mouseMove(t){if(this.mousedown){console.log(e,n);var e=t.clientX/1e3*180/Math.PI,n=t.clientY/1e3*180/Math.PI;console.log(e,n),document.getElementById("board-wrapper").style.WebkitTransform=`\n    perspective(2040px)\n    rotateX(${e}deg)\n    rotateY(${e}deg)\n    translateZ(217px)\n    `,this.mx=t.clientX,this.my=t.clientY}}stopMouseMove(){this.mousedown=!1}start(){this._previousElapsed=0,Promise.all(this.asm.loadAssets()).then(function(t){this.init(),window.requestAnimationFrame(this.tick)}.bind(this))}init(){var t=this.asm.get("prophetess");t.id="character-token",t.style.left=2.5*-t.width*(this.width/4581)+"px",t.style.top=4*t.height*(this.height/3026)+"px",document.getElementById("board-wrapper").appendChild(t),this.loopTiles(t),(t=this.asm.get("100x100")).id="character-token",t.style.left=2.5*-t.width*(this.width/4581)+"px",t.style.top=4*t.height*(this.height/3026)+"px";for(var e=1;e<50;e++){let n=document.createElement("img");n.src=t.src,n.id="tile-button",n.style.left="-50px",n.style.top="+150px",this.boardEl.appendChild(n),this.moveToTile(n,e)}var n=document.getElementById("dice");this.spinDice(n)}async spinDice(t){let e=0,n=0,i=117;for(;;)n+=86,e+=36,i+=10,e%=360,n%=360,i%=117,t.style.WebkitTransform=`rotateX(${n}deg)rotateZ(${e}deg) translateZ(${i}px)`,await this.timeout(1500)}async loopTiles(t){for(var e=1;e<50;e++)this.moveToTile(t,e),await this.timeout(500)}moveToTile(t,e){this.moveToTileAtPos(t,talisman.talisman_board[e].center.x,talisman.talisman_board[e].center.y)}zoomToTile(t,e){let n=90;e<7||e>25&&e<29||e>45&&e<48?n=180:e<13||e<33&&e>29?n=90:e<19||e<37&&e>33?n=0:(e<24||e<40&&e>36)&&(n=-90),this.transformBoard(35,n,0,0)}moveToTileAtPos(t,e,n){this.move(t,e*(this.width/4581),n*(this.height/3026))}transform(t,e,n,i={x:0,y:0}){t.style.WebkitTransform=`\n    perspective(2040px)\n    rotateX(${e}deg)\n    rotateZ(${n}deg)\n    rotate(-90deg)\n    translateZ(217px)\n    translate3d(${i.x}px, ${i.y}px, 10px)\n    `}move(t,e,n){t.style.WebkitTransform=`translate3d(${e}px, ${n}px, 0px)`,t.style.WebkitTransform+="rotateX(5deg)"}moveBoard(t,e){this.boardEl.style.WebkitTransform=`translate3d(${t}px, ${e}px, 0px)`}update(t){}timeout(t){return new Promise(e=>setTimeout(e,t))}transformBoard(t,e,n,i=1,r={x:0,y:0}){this.boardEl.style.WebkitTransform=`perspective(2040px) rotateX(${t}deg) rotateZ(${e}deg) rotateY(${n}deg) translateZ(${217*i}px) `,this.boardEl.style.WebkitTransform+=`translate3d(${r.x}px, ${r.y}px, 0px)`}transform_(){var t=camera.getOrientation(),e=camera.getPosition();cameraElem.style.WebkitTransform="rotateX("+t[0]+"deg) rotateY("+t[1]+"deg) rotateZ("+t[2]+"deg)",assemblyElem.style.WebkitTransform="translate3d("+-e[0]+"px, "+-e[1]+"px, "+-e[2]+"px)"}render(){this.dirty_frames.forEach(t=>{this.ctx.clearRect(t.x,t.y,t.width,t.height),this._drawBoard(t)}),this.dirty_frames=[]}_drawImage(t,e,n,i={width:null,width:null}){const r=this.asm.get(t);if(i.frame){const t=i.frame;this.ctx.drawImage(r,t.x,t.y,t.width*(r.width/i.width),t.height*(r.height/i.height),t.x,t.y,t.width,t.height)}else console.log(i.width),this.ctx.drawImage(r,e,n,i.width||r.width,i.height||r.height)}_drawBoard(t=null){this._drawImage("board",0,0,{width:this.width,height:this.height,frame:t})}tick=t=>{window.requestAnimationFrame(this.tick);var e=(t-this._previousElapsed)/1e3;e=Math.min(e,.25),this._previousElapsed=t,this.update(e),this.dirty_frames.length&&this.render()}}