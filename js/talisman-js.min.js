!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("StateMachine",[],e):"object"==typeof exports?exports.StateMachine=e():t.StateMachine=e()}(this,(function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.i=function(t){return t},n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:i})},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=5)}([function(t,e,n){"use strict";t.exports=function(t,e){var n,i,r;for(n=1;n<arguments.length;n++)for(r in i=arguments[n])i.hasOwnProperty(r)&&(t[r]=i[r]);return t}},function(t,e,n){"use strict";var i=n(0);t.exports={build:function(t,e){var n,r,o,s=e.plugins;for(n=0,r=s.length;n<r;n++)(o=s[n]).methods&&i(t,o.methods),o.properties&&Object.defineProperties(t,o.properties)},hook:function(t,e,n){var i,r,o,s,a=t.config.plugins,l=[t.context];for(n&&(l=l.concat(n)),i=0,r=a.length;i<r;i++)s=a[i],(o=a[i][e])&&o.apply(s,l)}}},function(t,e,n){"use strict";function i(t){if(0===t.length)return t;var e,n,i=t.split(/[_-]/);if(1===i.length&&i[0][0].toLowerCase()===i[0][0])return t;for(n=i[0].toLowerCase(),e=1;e<i.length;e++)n=n+i[e].charAt(0).toUpperCase()+i[e].substring(1).toLowerCase();return n}i.prepended=function(t,e){return t+(e=i(e))[0].toUpperCase()+e.substring(1)},t.exports=i},function(t,e,n){"use strict";var i=n(0),r=n(2);function o(t,e){t=t||{},this.options=t,this.defaults=e.defaults,this.states=[],this.transitions=[],this.map={},this.lifecycle=this.configureLifecycle(),this.init=this.configureInitTransition(t.init),this.data=this.configureData(t.data),this.methods=this.configureMethods(t.methods),this.map[this.defaults.wildcard]={},this.configureTransitions(t.transitions||[]),this.plugins=this.configurePlugins(t.plugins,e.plugin)}i(o.prototype,{addState:function(t){this.map[t]||(this.states.push(t),this.addStateLifecycleNames(t),this.map[t]={})},addStateLifecycleNames:function(t){this.lifecycle.onEnter[t]=r.prepended("onEnter",t),this.lifecycle.onLeave[t]=r.prepended("onLeave",t),this.lifecycle.on[t]=r.prepended("on",t)},addTransition:function(t){this.transitions.indexOf(t)<0&&(this.transitions.push(t),this.addTransitionLifecycleNames(t))},addTransitionLifecycleNames:function(t){this.lifecycle.onBefore[t]=r.prepended("onBefore",t),this.lifecycle.onAfter[t]=r.prepended("onAfter",t),this.lifecycle.on[t]=r.prepended("on",t)},mapTransition:function(t){var e=t.name,n=t.from,i=t.to;return this.addState(n),"function"!=typeof i&&this.addState(i),this.addTransition(e),this.map[n][e]=t,t},configureLifecycle:function(){return{onBefore:{transition:"onBeforeTransition"},onAfter:{transition:"onAfterTransition"},onEnter:{state:"onEnterState"},onLeave:{state:"onLeaveState"},on:{transition:"onTransition"}}},configureInitTransition:function(t){return"string"==typeof t?this.mapTransition(i({},this.defaults.init,{to:t,active:!0})):"object"==typeof t?this.mapTransition(i({},this.defaults.init,t,{active:!0})):(this.addState(this.defaults.init.from),this.defaults.init)},configureData:function(t){return"function"==typeof t?t:"object"==typeof t?function(){return t}:function(){return{}}},configureMethods:function(t){return t||{}},configurePlugins:function(t,e){var n,i,r;for(n=0,i=(t=t||[]).length;n<i;n++)"function"==typeof(r=t[n])&&(t[n]=r=r()),r.configure&&r.configure(this);return t},configureTransitions:function(t){var e,n,i,r,o,s=this.defaults.wildcard;for(n=0;n<t.length;n++)for(i=t[n],r=Array.isArray(i.from)?i.from:[i.from||s],o=i.to||s,e=0;e<r.length;e++)this.mapTransition({name:i.name,from:r[e],to:o})},transitionFor:function(t,e){var n=this.defaults.wildcard;return this.map[t][e]||this.map[n][e]},transitionsFor:function(t){var e=this.defaults.wildcard;return Object.keys(this.map[t]).concat(Object.keys(this.map[e]))},allStates:function(){return this.states},allTransitions:function(){return this.transitions}}),t.exports=o},function(t,e,n){var i=n(0),r=n(6),o=n(1),s=[null,[]];function a(t,e){this.context=t,this.config=e,this.state=e.init.from,this.observers=[t]}i(a.prototype,{init:function(t){if(i(this.context,this.config.data.apply(this.context,t)),o.hook(this,"init"),this.config.init.active)return this.fire(this.config.init.name,[])},is:function(t){return Array.isArray(t)?t.indexOf(this.state)>=0:this.state===t},isPending:function(){return this.pending},can:function(t){return!this.isPending()&&!!this.seek(t)},cannot:function(t){return!this.can(t)},allStates:function(){return this.config.allStates()},allTransitions:function(){return this.config.allTransitions()},transitions:function(){return this.config.transitionsFor(this.state)},seek:function(t,e){var n=this.config.defaults.wildcard,i=this.config.transitionFor(this.state,t),r=i&&i.to;return"function"==typeof r?r.apply(this.context,e):r===n?this.state:r},fire:function(t,e){return this.transit(t,this.state,this.seek(t,e),e)},transit:function(t,e,n,i){var r=this.config.lifecycle,o=this.config.options.observeUnchangedState||e!==n;return n?this.isPending()?this.context.onPendingTransition(t,e,n):(this.config.addState(n),this.beginTransit(),i.unshift({transition:t,from:e,to:n,fsm:this.context}),this.observeEvents([this.observersForEvent(r.onBefore.transition),this.observersForEvent(r.onBefore[t]),o?this.observersForEvent(r.onLeave.state):s,o?this.observersForEvent(r.onLeave[e]):s,this.observersForEvent(r.on.transition),o?["doTransit",[this]]:s,o?this.observersForEvent(r.onEnter.state):s,o?this.observersForEvent(r.onEnter[n]):s,o?this.observersForEvent(r.on[n]):s,this.observersForEvent(r.onAfter.transition),this.observersForEvent(r.onAfter[t]),this.observersForEvent(r.on[t])],i)):this.context.onInvalidTransition(t,e,n)},beginTransit:function(){this.pending=!0},endTransit:function(t){return this.pending=!1,t},failTransit:function(t){throw this.pending=!1,t},doTransit:function(t){this.state=t.to},observe:function(t){if(2===t.length){var e={};e[t[0]]=t[1],this.observers.push(e)}else this.observers.push(t[0])},observersForEvent:function(t){for(var e,n=0,i=this.observers.length,r=[];n<i;n++)(e=this.observers[n])[t]&&r.push(e);return[t,r,!0]},observeEvents:function(t,e,n,i){if(0===t.length)return this.endTransit(void 0===i||i);var r=t[0][0],s=t[0][1],a=t[0][2];if(e[0].event=r,r&&a&&r!==n&&o.hook(this,"lifecycle",e),0===s.length)return t.shift(),this.observeEvents(t,e,r,i);var l=s.shift(),c=l[r].apply(l,e);return c&&"function"==typeof c.then?c.then(this.observeEvents.bind(this,t,e,r)).catch(this.failTransit.bind(this)):!1===c?this.endTransit(!1):this.observeEvents(t,e,r,c)},onInvalidTransition:function(t,e,n){throw new r("transition is invalid in current state",t,e,n,this.state)},onPendingTransition:function(t,e,n){throw new r("transition is invalid while previous transition is still in progress",t,e,n,this.state)}}),t.exports=a},function(t,e,n){"use strict";var i=n(0),r=n(2),o=n(1),s=n(3),a=n(4),l={is:function(t){return this._fsm.is(t)},can:function(t){return this._fsm.can(t)},cannot:function(t){return this._fsm.cannot(t)},observe:function(){return this._fsm.observe(arguments)},transitions:function(){return this._fsm.transitions()},allTransitions:function(){return this._fsm.allTransitions()},allStates:function(){return this._fsm.allStates()},onInvalidTransition:function(t,e,n){return this._fsm.onInvalidTransition(t,e,n)},onPendingTransition:function(t,e,n){return this._fsm.onPendingTransition(t,e,n)}},c={state:{configurable:!1,enumerable:!0,get:function(){return this._fsm.state},set:function(t){throw Error("use transitions to change state")}}};function d(t){return h(this||{},t)}function h(t,e){return u(t,new s(e,d)),t._fsm(),t}function u(t,e){if("object"!=typeof t||Array.isArray(t))throw Error("StateMachine can only be applied to objects");o.build(t,e),Object.defineProperties(t,c),i(t,l),i(t,e.methods),e.allTransitions().forEach((function(e){t[r(e)]=function(){return this._fsm.fire(e,[].slice.call(arguments))}})),t._fsm=function(){this._fsm=new a(this,e),this._fsm.init(arguments)}}d.version="3.0.1",d.factory=function(){var t,e;"function"==typeof arguments[0]?(t=arguments[0],e=arguments[1]||{}):(t=function(){this._fsm.apply(this,arguments)},e=arguments[0]||{});var n=new s(e,d);return u(t.prototype,n),t.prototype._fsm.config=n,t},d.apply=h,d.defaults={wildcard:"*",init:{name:"init",from:"none"}},t.exports=d},function(t,e,n){"use strict";t.exports=function(t,e,n,i,r){this.message=t,this.transition=e,this.from=n,this.to=i,this.current=r}}])}));var talisman=talisman||{};talisman.creatures=[{name:"wolf",type:"animal",strength:4,wisdom:0},{name:"storm_caller",type:"cultist",strength:4,wisdom:0,conditional:{target:"player",if:{has_armour:!0},do:{lose_life:1}}}],talisman.modifiers=[{name:"always_one_spell",callbacks:{update:{conditional:{target:"this",if:{less_than_or_eq:["spell_count",0]},do:{draw_spell:1}}}}}],talisman.talisman_board={0:{name:"city",neighbours:[2,24],conditional:{use_raft:[25]},center:{x:410,y:270},col:1,row:1,id:1},1:{name:"fields",neighbours:[1,3],conditional:{use_raft:[25,26]},center:{x:1e3,y:270},col:2,row:1,id:2},2:{name:"hills",neighbours:[2,4],conditional:{use_raft:[26,27]},center:{x:1650,y:270},col:3,row:1,id:3},3:{name:"plains",neighbours:[3,5],conditional:{use_raft:[27]},center:{x:2300,y:270},col:4,row:1,id:4},4:{name:"woods",neighbours:[4,6],conditional:{use_raft:[27,28]},center:{x:2930,y:270},col:5,row:1,id:5},5:{name:"plains",neighbours:[5,7],conditional:{use_raft:[28,29]},center:{x:3580,y:270},col:6,row:1,id:6},6:{name:"tavern",neighbours:[6,8],conditional:{use_raft:[29]},center:{x:4275,y:285},col:7,row:1,id:7},7:{name:"fields",neighbours:[7,9],conditional:{use_raft:[29]},center:{x:4275,y:660},col:7,row:2,id:8},8:{name:"runes",neighbours:[8,10],conditional:{use_raft:[29,30,31]},center:{x:4275,y:1170},col:7,row:3,id:9},9:{name:"plains",neighbours:[9,11],conditional:{use_raft:[31,32]},center:{x:4275,y:1640},col:7,row:4,id:10},10:{name:"forest",neighbours:[10,12],conditional:{use_raft:[32,33]},center:{x:4275,y:1980},col:7,row:5,id:11},11:{name:"fields",neighbours:[11,13],conditional:{use_raft:[33]},center:{x:4275,y:2350},col:7,row:6,id:12},12:{name:"village",neighbours:[12,14],conditional:{use_raft:[33]},center:{x:4200,y:2750},col:7,row:7,id:13},13:{name:"fields",neighbours:[13,15],conditional:{use_raft:[33,34]},center:{x:3575,y:2760},col:6,row:7,id:14},14:{name:"graveyard",neighbours:[14,16],conditional:{use_raft:[34,35]},center:{x:2925,y:2760},col:5,row:7,id:15},15:{name:"woods",neighbours:[15,17],conditional:{use_raft:[35]},center:{x:2255,y:2760},col:4,row:7,id:16},16:{name:"sentinel",neighbours:[16,18,36],conditional:{use_raft:[36,35]},center:{x:1650,y:2760},col:3,row:7,id:17},17:{name:"hills",neighbours:[17,19],conditional:{use_raft:[36,37]},center:{x:1e3,y:2760},col:2,row:7,id:18},18:{name:"chapel",neighbours:[18,20],conditional:{use_raft:[37]},center:{x:405,y:2740},col:1,row:7,id:19},19:{name:"fields",neighbours:[19,21],conditional:{use_raft:[37]},center:{x:310,y:2355},col:1,row:6,id:20},20:{name:"crags",neighbours:[20,22],conditional:{use_raft:[37,38]},center:{x:310,y:1940},col:1,row:5,id:21},21:{name:"plains",neighbours:[21,23],conditional:{use_raft:[39,40]},center:{x:310,y:1535},col:1,row:4,id:22},22:{name:"woods",neighbours:[22,24],conditional:{use_raft:[40,25]},center:{x:310,y:1110},col:1,row:3,id:23},23:{name:"fields",neighbours:[23,1],conditional:{use_raft:[25]},center:{x:310,y:700},col:1,row:2,id:24},24:{name:"warlock's cave",neighbours:[26,40],conditional:{use_raft:[1,2,24]},center:{x:900,y:710},col:2,row:2,id:25},25:{name:"desert",neighbours:[25,26],conditional:{use_raft:[2,3]},center:{x:1550,y:710},col:3,row:2,id:26},26:{name:"oasis",neighbours:[26,28],conditional:{use_raft:[3,4,5]},center:{x:2300,y:710},col:4,row:2,id:27},27:{name:"desert",neighbours:[27,29],conditional:{use_raft:[5,6]},center:{x:3060,y:710},col:5,row:2,id:28},28:{name:"temple",neighbours:[28,30],conditional:{use_raft:[6,7,8,9]},center:{x:3760,y:750},col:6,row:2,id:29},29:{name:"woods",neighbours:[29,31],conditional:{use_raft:[9]},center:{x:3830,y:1135},col:6,row:3,id:30},30:{name:"runes",neighbours:[30,32],conditional:{use_raft:[9,10]},center:{x:3830,y:1545},col:6,row:4,id:31},31:{name:"castle",neighbours:[31,33],conditional:{use_raft:[10,11]},center:{x:3830,y:1920},col:6,row:5,id:32},32:{name:"portal_of_power",neighbours:[32,34,41],conditional:{use_raft:[12,13,14]},center:{x:3680,y:2310},col:6,row:6,id:33},33:{name:"black_knight",neighbours:[33,35],conditional:{use_raft:[14,15]},center:{x:3020,y:2300},col:5,row:6,id:34},34:{name:"hidden_valley",neighbours:[34,36],conditional:{use_raft:[15,16,17]},center:{x:2300,y:2300},col:4,row:6,id:35},35:{name:"hills",neighbours:[35,37,17],conditional:{defeat_sentinel:[35,37],use_raft:[17,18]},center:{x:1530,y:2300},col:3,row:6,id:36},36:{name:"cursed_glade",neighbours:[36,38],conditional:{use_raft:[18,19,20]},center:{x:840,y:2290},col:2,row:6,id:37},37:{name:"runes",neighbours:[37,39],conditional:{use_raft:[21]},center:{x:780,y:1920},col:2,row:5,id:38},38:{name:"chasm",neighbours:[38,40],conditional:{use_raft:[22]},center:{x:780,y:1545},col:2,row:4,id:39},39:{name:"runes",neighbours:[39,25],conditional:{use_raft:[22,23]},center:{x:780,y:1135},col:2,row:3,id:40},40:{name:"plain_of_peril",neighbours:[33,45,46],conditional:{portal_of_power:null},center:{x:3150,y:1900},col:5,row:5,id:41},41:{name:"mines",neighbours:[41,43],center:{x:2335,y:1900},col:4,row:5,id:42},42:{name:"vampire's tower",neighbours:[42,44],center:{x:1420,y:1900},col:3,row:5,id:43},43:{name:"pits",neighbours:[43],conditional:{has_talisman:[48]},center:{x:1310,y:1510},col:3,row:4,id:44},44:{name:"crypt",neighbours:[41,46],center:{x:3390,y:1520},col:5,row:4,id:45},45:{name:"dice_with_death",neighbours:[45,47],center:{x:3165,y:1140},col:5,row:3,id:46},46:{name:"werewolf_den",neighbours:[46,48],center:{x:2335,y:1135},col:4,row:3,id:47},47:{name:"valley of fire",neighbours:[44,47,49],center:{x:1420,y:1140},col:3,row:3,id:48},48:{name:"crown_of_command",neighbours:[48],center:{x:2330,y:1515},col:4,row:4,id:49},49:{name:"crown_of_command",neighbours:[48],center:{x:2330,y:1515},col:4,row:4,id:49}};class Atom{constructor(){}init(t){this.onInit(t)}update(t){this.onUpdate(t)}onInit(t){}onUpdate(t){}}class BaseEntity extends Atom{constructor(t,e,n,i,r=[],o=[]){super(),this.state={name:t,real_name:e,type:n,category:i};for(let t in r)r[t](this,o[t])}}class Entity extends BaseEntity{constructor(t,e,n,i,r=[],o=[]){super(t,e,n,i,r,o)}canHold(){return!0}canUse(){return!0}use(){return this.onUse(),!0}added(t){return this.onAdded(t),!0}removed(t){return this.onRemoved(t)}used(t,e=null){return this.onUsed(t,e),{val:!0}}canDrop(t){return this.onCanDrop()}onCanDrop(){return!0}onAdded(t){return{val:!0}}onRemoved(t){return!0}onUse(t,e){return!0}reqUse(t,e=null){return this.onReqUse(t,e)}reqAdd(t){return this.onReqAdd(t)}onReqUse(t,e=null){return{val:!0}}onReqUse(t){return{val:!0}}}class Follower extends Entity{constructor(t,e,n,i,r=[],o=[]){super(t,e,n,i,r,o)}}class Item extends Entity{constructor(t,e,n,i,r=[],o=[]){super(t,e,n,i,r,o)}}function add_mod(t,e,n,i=!1){let r=t[e].bind(t);t[e]=t=>{n(t),i||r()}}function add_mod2(t,e){let n=t[e.when].bind(t);t[e.when]=t=>{0==e.replace&&n(),e.callback(t)}}function add_mod2_cond(t,e){let n=t[e.when].bind(t);t[e.when]=i=>{let r=e.callback(i);return n?r:{val:!1,txt:`${i.state.real_name} cannot use ${t.state.real_name}.`}}}function always_x_of_spells(t,e){add_mod2(t,{when:"onUpdate",callback:n=>{t.spellCount()<e.amount&&n.drawSpell(t,e.amount-t.spellCount())}})}function may_mulligan_cards(t,e){null==t.type?add_mod2(t,{when:"onDrawCard",callback:t=>{console.log(t.deck),t.deck==e.deck&&(game.turn.mulligans=Math.max(Math.min(t.amount,e.amount),game.turn.mulligans),console.log("Added mulligans ",game.turn.mulligans))},replace:!1}):(event={event:EVENT.DRAW_CARD,action:t=>{t.turn.mulligans=Math.max(t.turn.mulligans,1)}},PubSub.enable(t),t.subscribe(event.event,action.action))}function change_inventory_size(t,e=4){var n=document.getElementById("inventory").getElementsByTagName("tbody")[0];if(e>0)for(var i=document.createElement("tr"),r=t.state.carryLimit+1;r-1<t.state.carryLimit+e;r++){var o=document.createElement("td");o.id="i"+r,o.setAttribute("class","slot"),i.appendChild(o),r%4==0&&(n.appendChild(i),i=document.createElement("tr"))}else for(r=0;r<-e/4;r++)n.deleteRow(n.rows-r);t.state.carryLimit+=e}function carry_limit_increase(t,e){add_mod(t,"onAdded",t=>{change_inventory_size(t,e.change)}),add_mod(t,"onRemoved",t=>{change_inventory_size(t,-e.change)})}function discard_on_remove(t){add_mod2_cond(t,{when:"onRemoved",callback:()=>({val:!1,text:t.state.real_name+" was discarded."}),replace:!0}),cant_be_dropped(t)}function cant_be_dropped(t){add_mod2_cond(t,{when:"onCanDrop",callback:()=>({val:!1,text:t.state.real_name+" can't be dropped."}),replace:!0})}function required_alignment_to_use(t,e){add_mod2_cond(t,{when:"onReqUse",callback:(n,i)=>n.state.alignment===e.alignment!=(!1===e.NOT)?{val:!0,text:`${t.state.real_name} CAN be used by ${e.alignment} characters`}:{val:!1,text:`${t.state.real_name} can ONLY be used by ${e.alignment} characters`}})}function required_alignment_to_pickup(t,e,n=!1){}function weapon_lifesteal(t,e=1){add_mod2(t,"onBattleWon",(n,i)=>{"creature"==i.type?(console.log(`${t.state.real_name} was used to steal ${e} life from ${i.state.real_name}`),n.changes.lives=1):-1==i.changes&&(console.log(`${t.state.real_name} was used to steal ${e} life from ${i.state.name}`),n.changes.lives=1)})}const RuneSword=()=>new Item("rune_sword","Rune sword","item","Magical Item",[required_alignment_to_use],[{alignment:"evil"}]),CrystalBall=()=>new Item("crystal_ball","Crystal Ball","item","Magical Item"),spell_book=()=>new Item("spell_book","magical_item",[always_one_spell]),rune_sword=()=>new Item("rune_sword","magical_weapon",[required_alignment_to_use,weapon_lifesteal],[{alignment:"evil"},{amount:1}]),holy_grail=()=>new Item("holy_grail","magical_item",[required_alignment_to_use],[{alignment:"good"}]),Mule=()=>new Follower("mule","Mule","follower","Animal",[carry_limit_increase],[{change:4}]),HorseAndCart=()=>new Follower("horse_and_cart","follower",[carry_limit_increase],[{change:8}]);class Character extends Entity{constructor(t,e,n,i,r,o,s=new Map,a=new Map,l=new Map,c=new Array){super(),this.state={name:t,health:e,strength:n,craft:i,fate:r,gold:o,carryLimit:4,items:s,followers:a,spells:l,trophys:c},this.changes={lives:0,strength:0,craft:0,fate:0}}get(t){}add(t){this.state[t.state.type+"s"]}remove(t){}addEntity(t){this.state[t.state.type+"s"][t.state.name]=t,t.added(this),console.log(`${this.state.name} added ${t.state.type}:  ${t.state.name}`)}discardEntity(t,e){let n=this.state[e+"s"];n[t].removed(this),n.delete(t)}dropEntity(t,e){let n=this.state[e+"s"],i=n[t].canDrop(this);if(0==i.val)return i;n[t].removed(this);let r=Object.create(n[t]);return n.delete(t),{val:r}}useEntity(t,e,n=null){return this.state[e+"s"][t].use(this,n)}canUse(t,e,n=null){return this.state[e+"s"][t].reqUse(this,n)}drawCard(t){t={game:t.game,deck:t.deck?t.deck:"adventure",amount:t.amount?t.amount:1},this.onDrawCard(t)}onDrawCard(){}battleWon(t){this.onBattleWon(t)}onBattleWon(t){console.log(t),"creature"==t.state.type&&t.defeated(this)}addTrophy(t){console.log(`${this.state.name} gained a trophy: ${t.state.real_name} with ${t.value.value+" "+t.value.type} .`),this.state.trophys.push(t)}useSpell(){this.onUseSpell()}addSpell(t){this.state.spells[t.name]=t}hasMaxSpells(){return this.spellCount()<this.maxSpells()}maxSpells(){return Math.min(0,Math.floor(this.state.craft/2))}spellCount(){return this.state.spells.size}}class Prophetess extends Character{constructor(){super("Prophetess",2,4,4,2,"good"),always_x_of_spells(this,{amount:1}),may_mulligan_cards(this,{deck:"adventure",amount:1})}}class Creature extends BaseEntity{constructor(t,e,n,i,r,o,s=[],a=[]){super(t,e,n,i,s,a),this.value={type:r?"strength":"craft",value:r||o}}defeated(t){t.addTrophy(this),this.onDefeated(t)}onDefeated(t){}}const Wolf=()=>new Creature("wolf","Wolf","creature","Animal",2,0);function Board(t){this.asm=t,this.el=document.getElementById("board-wrapper"),this.ctx=document.getElementById("board").getContext("2d"),this.width=969,this.height=640,this.tiles=talisman.talisman_board,this.dirty_frames=[{x:0,y:0,width:this.width,height:this.height}],this.walkDelayMS=400,this.graph=new Graph(graph_cfg)}Board.prototype.initialize=function(){let t=this.asm.get("100x100");t.id="character-token",t.style.left=2.5*-t.width*(this.width/4581)+"px",t.style.top=4*t.height*(this.height/3026)+"px";for(var e=0;e<49;e++){let n=document.createElement("img");n.src=t.src,n.index=e,n.id="tile-button",n.style.left="-50px",n.style.top="+150px",this.el.appendChild(n),this.moveToTileID(n,e),n.onclick=()=>this._tilePressed(n.index),this.tiles[e].el=n}},Board.prototype.render=function(){this.dirty_frames.forEach(t=>{this.ctx.clearRect(t.x,t.y,t.width,t.height),this._drawBoard(t)}),this.dirty_frames=[]},Board.prototype._drawImage=function(t,e,n,i={width:null,width:null}){const r=this.asm.get(t);if(i.frame){const t=i.frame;this.ctx.drawImage(r,t.x,t.y,t.width*(r.width/i.width),t.height*(r.height/i.height),t.x,t.y,t.width,t.height)}else console.log(i.width),this.ctx.drawImage(r,e,n,i.width||r.width,i.height||r.height)},Board.prototype._drawBoard=function(t=null){this._drawImage("board",0,0,{width:this.width,height:this.height,frame:t})},Board.prototype.move=function(t,e,n){t.style.WebkitTransform=`translate3d(${e}px, ${n}px, 0px)`},Board.prototype.moveBoard=function(t,e){this.el.style.WebkitTransform=`translate3d(${t}px, ${e}px, 0px)`},Board.prototype.moveToTileAtPos=function(t,e,n){this.move(t,e*(this.width/4581),n*(this.height/3026))},Board.prototype.moveToTileID=function(t,e){this.moveToTileAtPos(t,this.tiles[e].center.x,this.tiles[e].center.y)},Board.prototype.walkToTileID=async function(t,e){this.moveToTileAtPos(t,this.tiles[e].center.x,this.tiles[e].center.y),this.currentIndex=e,await this._timeout(this.walkDelayMS)},Board.prototype.walkToTile=async function(t,e){this.moveToTileAtPos(t,e.center.x,e.center.y),await this._timeout(this.walkDelayMS)},Board.prototype.moveToTile=function(t,e){this.moveToTileAtPos(t,e.center.x,e.center.y)},Board.prototype.walkPath=async function(t,e,n){null!=e&&(this.moveToTileID(t,e),console.log(e),await this._timeout(this.walkDelayMS),this.currentIndex=e,this.walkPath(t,n[e],n))},Board.prototype._tilePressed=function(t){if(console.log(t),this.currentPlayerMove){this.moveToTileID(this.currentPlayerMove,t+1);let[e,n]=this.graph.dijkstra(t);this.walkPath(this.currentPlayerMove,this.currentIndex,n)}},Board.prototype._timeout=function(t){return new Promise(e=>setTimeout(e,t))};const deck_cfg={adventure_deck:{name:"adventure_deck",real_name:"Adventure Deck",cards:["wolf","dragon","demon"]}};function Deck(t){this.name=t.name,this.real_name=t.real_name,this.cards=t.cards}function Dice(){return el=document.getElementById("dice"),{spinDice:async function(){let e=0,n=0,i=117;for(;;)n+=86,e+=36,i+=10,e%=360,n%=360,i%=117,el.style.WebkitTransform=`rotateX(${n}deg)rotateZ(${e}deg) translateZ(${i}px)`,await t(1500)}};function t(t){return new Promise(e=>setTimeout(e,t))}}Deck.prototype.draw=function(t=1){return this.cards.splice(this.cards.length-t,t)},Deck.prototype.shuffle=function(){for(var t,e,n=this.cards.length;0!==n;)e=Math.floor(Math.random()*n),n-=1,t=this.cards[n],this.cards[n]=this.cards[e],this.cards[e]=t},Dice.prototype.roll=function(t=1){var e=t;for(let t=0;t<numDic;t++)e+=Math.floor(6*Math.random());return e},EVENT={CREATURE_DEFEATED:0,CREATURE_KILLED:1,CREATURE_STALEMATE:2,PLAYER_DEFATED:3,PLAYER_KILLED:4,PLAYER_STALEMATE:5,SPELL_CAST:6};const game_cfg={state:{init:"init",transitions:[{name:"startTurn",from:["init","end_turn"],to:"start_turn"},{name:"movement",from:["entity_effect","card_effect","tile_effect","spell_effect","dice_result","start_turn","use_entity"],to:"move"},{name:"last_turn",from:["battle_won","encounter_end"],to:"end_turn"},{name:"diceResult",from:"roll_dice",to:"dice_result"},{name:"useFate",from:["roll_dice"],to:"dice_result"},{name:"useEntity",from:["start_turn","roll_dice","encounter"],to:"use_entity"},{name:"encounter",from:"move",to:"encounter"},{name:"encounterTile",from:["encounter","defeat_creature","evade_creature","movement"],to:"tile_effect"},{name:"encounterDrawTile",from:"encounter",to:"encounter_draw_tile"},{name:"encounterCharacter",from:"encounter",to:"encounter_character"},{name:"engageBattle",from:["encounter_character","encounter_creature","card_effect","tile_effect","spell_effect"],to:"engage_battle"},{name:"battleLost",from:"engage_battle",to:"battle_lost"},{name:"battleWon",from:"engage_battle",to:"battle_won"},{name:"battleStalemate",from:"engage_battle",to:"end_turn"},{name:"specialAbility",from:["encounter","encounter_character","encounter_creature","encounter_card","engage_creature","engage_character","roll_dice"]},{name:"applyChanges",from:"encounter_end"},{name:"missTurn",from:["start_turn","tile_effect","spell_effect","card_effect"],to:"end_turn"},{name:"drawCard",from:["encounter_draw_tile","card_effect","tile_effect"],to:"draw_card"},{name:"mulliganCard",from:"draw_card",to:"mulligan_card"},{name:"encounterCard",from:["encounter","tile_effect","encounter_draw_tile","draw_card"],to:"card_effect"},{name:"rollDice",from:["start_turn","entity_effect","card_effect","tile_effect","spell_effect","movement"],to:"roll_dice"},{name:"endTurn",from:["encounter_end","battle_stalemate","battle_end"]}]},events:[{event:EVENT.CREATURE_DEFEATED,action:function(t,e){this.onCreatureWon(t,e)}},{event:EVENT.CREATURE_KILLED,action:function(t,e){this.onCreatureKilled(t,e)}},{event:EVENT.CREATURE_STALEMATE,action:function(t,e){this.onCreatureStalemate(t,e)}},{event:EVENT.PLAYER_DEFEATED,action:function(t,e){this.onPlayerDefeated(character,e)}},{event:EVENT.PLAYER_KILLED,action:function(t,e){this.onPlayerKilled(character,e)}},{event:EVENT.PLAYER_STALEMATE,action:function(t,e){this.onPlayerStalemate(character,e)}},{event:EVENT.SPELL_CAST,action:function(t,e,n=null){this.onSpellCast(t,e,n)}},{event:EVENT.ENTITY_USED,action:function(t,e,n=null){this.onEntityUsed(t,e,n)}},{event:EVENT.ROLL_DIE,action:function(t){this.onRollDie(t)}},{event:EVENT.PLAYER_ROLL_DIE,action:function(t){this.onPlayerRollDie(t)}},{event:EVENT.PLAYER_DICE_RESULT,action:function(t){this.onPlayerRollDie(t)}},{event:EVENT.PLAYER_MOVE,action:function(t){this.onPlayerMove(t)}},{event:EVENT.PLAYER_DRAW_CARD,action:function(t){this.onPlayerDrawCard(t)}},{event:EVENT.PLAYER_DRAW_SPELL,action:function(t){this.onPlayerDrawSpell(t)}}]};PubSub={enable:function(t){t.subscribe=function(t,e){this.subscribers=this.subscribers||{},this.subscribers[t]=this.subscribers[t]||[],this.subscribers[t].push(e)},t.publish=function(e){if(console.log(e),this.subscribers&&this.subscribers[e]){var n,i,r=this.subscribers[e],o=[].slice.call(arguments,1);for(n=0,i=r.length;n<i;n++)r[n].apply(t,o)}}}};class Game extends StateMachine{constructor(t,e){console.log(t.state),super(t.state),this.asm=e,PubSub.enable(this);for(let e in t.events)this.subscribe(e,t.events[e].action)}}Game.prototype.onInit=function(){return console.log("init"),!1},Game.prototype.onStartTurn=function(){return console.log("Start turn"),!1},Game.prototype.testTurns=function(){console.log(this.allStates()),console.log(this.transitions());let t=["startTurn","useEntity","movement","encounter","encounterCharacter","engageBattle","battleWon","lastTurn"];for(let e in t)console.log(this.transitions()),this[t[e]](),console.log(this.state)};const graph_cfg={nodes:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48],edges:[[0,1],[1,2],[2,3],[3,4],[4,5],[5,6],[6,7],[7,8],[8,9],[9,10],[10,11],[11,12],[12,13],[13,14],[14,15],[15,16],[16,17],[17,18],[18,19],[19,20],[20,21],[21,22],[22,23],[23,0],[16,35],[24,25],[25,26],[26,27],[27,28],[28,29],[29,30],[30,31],[31,32],[32,33],[33,34],[34,35],[35,36],[36,37],[37,38],[38,39],[39,24],[32,40],[40,41],[41,42],[42,43],[43,47],[40,44],[44,45],[45,46],[46,47],[47,48]]};function Graph(t){return list=null,matrix=null,i(t.nodes,t.edges),{addNode:e,addEdge:n,createGraph:i,dfs:function t(e,n){if(e.id===n.id)return e;len=new Map;for(var i=0;i<e.children.length;i++)if(result=t(e.children[i],n),null!=result)return result;return null},dijkstra:function(t){for(var e=[],n=0;n<matrix.length;n++)e[n]=Number.MAX_VALUE;e[t]=0;var i=[],r=new Array(matrix.length);r[t]=null;for(;;){var o=Number.MAX_VALUE,s=-1;for(n=0;n<matrix.length;n++)e[n]<o&&!i[n]&&(o=e[n],s=n);if(-1===s)break;for(n=0;n<matrix[s].length;n++)0!==matrix[s][n]&&e[n]>e[s]+matrix[s][n]&&(r[n]=s,e[n]=e[s]+matrix[s][n]);i[s]=!0}return[e,r]}};function e(t){list.set(t,[]);for(let t=0;t<matrix.length;t++){matrix[t].push(0)}matrix.push(new Array(matrix.length).fill(0))}function n(t,e){list.get(t).push(e),list.get(e).push(t),matrix[t][e]=1,matrix[e][t]=1}function i(t,i){list=new Map,matrix=new Array,t.forEach(t=>e(t)),i.forEach(t=>n(t[0],t[1]))}}const Tree={findSubNode(t,e){if(t.id&&t.id==e)return t;if(null!=t.children){var n=null;for(let i=0;null==n&&i<t.children.length;i++)n=this.findSubNode(t.children[i],e);return n}return null},findNode(t,e){var n=null;let i=0;for(;null==n&&i<t.length;i++)n=this.findSubNode(t[i],e);return[n,t[i-1]]},flattenNodes(t,e=[]){if(e.push(t),t.children)for(let n=0;n<t.children.length;n++)e.concat(this.flattenNodes(t.children[n],e));return e.forEach(t=>{if(t.children)for(let e=0;e<t.children.length;e++)t.children=[]}),e},flatten(t){var e=[];return[...t].forEach(t=>{if(Array.isArray(t))e.push(...flatten(t));else if(t.children)for(let n=0;n<t.children.length;n++)e.concat(...this.flattenNodes(t.children[n],e))}),e.forEach(t=>{if(t.children)for(let e=0;e<t.children.length;e++)t.children=[]}),e.map(({id:t,parent:e,moves:n,conditionals:i})=>({id:t,parent:e,moves:n,conditionals:i,children:[]})),e},findPathToNode(t,e){let n=[e],i=new Set,r=[];for(;n.length>0;){r=n.shift();let t=r;if(void 0===t)return null;if(t.id==e.id)return r;i.has(t)||i.add(t)}}},assets_cfg={assets:[{id:"board",src:"assets/talisman_board_hr.jpg",width:4581,height:3026},{id:"prophetess",src:"assets/prophetess.png",width:120,height:120},{id:"100x100",src:"assets/100x100.png",width:100,height:100}]};function AssetsManager(t){return images={},{loadAssets:function(){return Array.from({length:t.assets.length},(e,i)=>n(t.assets[i].id,t.assets[i].src,{x:t.assets[i].width,y:t.assets[i].height}))},getImage:e,get:e,loadImage:n};function e(t){return t in images?images[t]:null}function n(t,e,n={x:null,y:null}){var i=new Image,r=new Promise(function(n,r){i.onload=function(){images[t]=i,n(i)}.bind(this),i.onerror=function(){r("Could not load image: "+e)}}.bind(this));return i.src=e,i.width=n.x,i.height=n.y,i.style=`width: ${n.x}px; height: ${n.y}px;`,r}}class GameOld{constructor(){this.boardEl=document.getElementById("board-wrapper"),this.ctx=document.getElementById("board").getContext("2d"),this.asm=new AssetsManager(cfg),this.width=969,this.height=640,this.dirty_frames=[{x:0,y:0,width:this.width,height:this.height}],this.mousedown=!1}initMouseMove(t){this.mousedown=!0,this.mx=t.clientX,this.my=t.clientY}rotate(t,e,n,i){var r=Math.cos(n),o=Math.sin(n),s=Math.cos(i),a=Math.sin(i),l=t.x-e.x,c=t.y-e.y,d=t.z-e.z;t.x=r*l-o*s*c+o*a*d+e.x,t.y=o*l+r*s*c-r*a*d+e.y,t.z=a*c+s*d+e.z}mouseMove(t){if(this.mousedown){console.log(e,n);var e=t.clientX/1e3*180/Math.PI,n=t.clientY/1e3*180/Math.PI;console.log(e,n),document.getElementById("board-wrapper").style.WebkitTransform=`\n    perspective(2040px)\n    rotateX(${e}deg)\n    rotateY(${e}deg)\n    translateZ(217px)\n    `,this.mx=t.clientX,this.my=t.clientY}}stopMouseMove(){this.mousedown=!1}start(){this._previousElapsed=0,Promise.all(this.asm.loadAssets()).then(function(t){this.init(),window.requestAnimationFrame(this.tick)}.bind(this))}init(){var t=this.asm.get("prophetess");t.id="character-token",t.style.left=2.5*-t.width*(this.width/4581)+"px",t.style.top=4*t.height*(this.height/3026)+"px",document.getElementById("board-wrapper").appendChild(t),this.loopTiles(t),(t=this.asm.get("100x100")).id="character-token",t.style.left=2.5*-t.width*(this.width/4581)+"px",t.style.top=4*t.height*(this.height/3026)+"px";for(var e=1;e<50;e++){let n=document.createElement("img");n.src=t.src,n.id="tile-button",n.style.left="-50px",n.style.top="+150px",this.boardEl.appendChild(n),this.moveToTile(n,e)}var n=document.getElementById("dice");this.spinDice(n)}async spinDice(t){let e=0,n=0,i=117;for(;;)n+=86,e+=36,i+=10,e%=360,n%=360,i%=117,t.style.WebkitTransform=`rotateX(${n}deg)rotateZ(${e}deg) translateZ(${i}px)`,await this.timeout(1500)}async loopTiles(t){for(var e=1;e<50;e++)this.moveToTile(t,e),await this.timeout(500)}moveToTile(t,e){this.moveToTileAtPos(t,talisman.talisman_board[e].center.x,talisman.talisman_board[e].center.y)}zoomToTile(t,e){let n=90;e<7||e>25&&e<29||e>45&&e<48?n=180:e<13||e<33&&e>29?n=90:e<19||e<37&&e>33?n=0:(e<24||e<40&&e>36)&&(n=-90),this.transformBoard(35,n,0,0)}moveToTileAtPos(t,e,n){this.move(t,e*(this.width/4581),n*(this.height/3026))}transform(t,e,n,i={x:0,y:0}){t.style.WebkitTransform=`\n    perspective(2040px)\n    rotateX(${e}deg)\n    rotateZ(${n}deg)\n    rotate(-90deg)\n    translateZ(217px)\n    translate3d(${i.x}px, ${i.y}px, 10px)\n    `}move(t,e,n){t.style.WebkitTransform=`translate3d(${e}px, ${n}px, 0px)`,t.style.WebkitTransform+="rotateX(5deg)"}moveBoard(t,e){this.boardEl.style.WebkitTransform=`translate3d(${t}px, ${e}px, 0px)`}update(t){}timeout(t){return new Promise(e=>setTimeout(e,t))}transformBoard(t,e,n,i=1,r={x:0,y:0}){this.boardEl.style.WebkitTransform=`perspective(2040px) rotateX(${t}deg) rotateZ(${e}deg) rotateY(${n}deg) translateZ(${217*i}px) `,this.boardEl.style.WebkitTransform+=`translate3d(${r.x}px, ${r.y}px, 0px)`}transform_(){var t=camera.getOrientation(),e=camera.getPosition();cameraElem.style.WebkitTransform="rotateX("+t[0]+"deg) rotateY("+t[1]+"deg) rotateZ("+t[2]+"deg)",assemblyElem.style.WebkitTransform="translate3d("+-e[0]+"px, "+-e[1]+"px, "+-e[2]+"px)"}render(){this.dirty_frames.forEach(t=>{this.ctx.clearRect(t.x,t.y,t.width,t.height),this._drawBoard(t)}),this.dirty_frames=[]}_drawImage(t,e,n,i={width:null,width:null}){const r=this.asm.get(t);if(i.frame){const t=i.frame;this.ctx.drawImage(r,t.x,t.y,t.width*(r.width/i.width),t.height*(r.height/i.height),t.x,t.y,t.width,t.height)}else console.log(i.width),this.ctx.drawImage(r,e,n,i.width||r.width,i.height||r.height)}_drawBoard(t=null){this._drawImage("board",0,0,{width:this.width,height:this.height,frame:t})}tick=t=>{window.requestAnimationFrame(this.tick);var e=(t-this._previousElapsed)/1e3;e=Math.min(e,.25),this._previousElapsed=t,this.update(e),this.dirty_frames.length&&this.render()}}window.onload=function(){asm=new this.AssetsManager(assets_cfg),Promise.all(asm.loadAssets()).then((function(t){var e=new Board(asm);e.initialize(),e.render();var n=this.asm.get("prophetess");n.id="character-token",n.style.left=2.5*-n.width*(e.width/4581)+"px",n.style.top=4*n.height*(e.height/3026)+"px",document.getElementById("board-wrapper").appendChild(n),e.currentPlayerMove=n,e.currentIndex=0,(new Dice).spinDice();new Game(game_cfg,this.asm);var i=new Deck(deck_cfg.adventure_deck);i.shuffle(),console.log(i.draw(2));var r=document.getElementById("card-container");e.moveToTileID(r,49)}))};