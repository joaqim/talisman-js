var talisman=talisman||{};talisman.talisman_board={1:{name:"city",neighbours:[2,24],conditional:{use_raft:[25]},center:{x:410,y:270}},2:{name:"fields",neighbours:[1,3],conditional:{use_raft:[25,26]},center:{x:1e3,y:270}},3:{name:"hills",neighbours:[2,4],conditional:{use_raft:[26,27]},center:{x:1650,y:270}},4:{name:"plains",neighbours:[3,5],conditional:{use_raft:[27]},center:{x:2300,y:270}},5:{name:"woods",neighbours:[4,6],conditional:{use_raft:[27,28]},center:{x:2930,y:270}},6:{name:"plains",neighbours:[5,7],conditional:{use_raft:[28,29]},center:{x:3580,y:270}},7:{name:"tavern",neighbours:[6,8],conditional:{use_raft:[29]},center:{x:4275,y:285}},8:{name:"fields",neighbours:[7,9],conditional:{use_raft:[29]},center:{x:4275,y:660}},9:{name:"runes",neighbours:[8,10],conditional:{use_raft:[29,30,31]},center:{x:4275,y:1170}},10:{name:"plains",neighbours:[9,11],conditional:{use_raft:[31,32]},center:{x:4275,y:1640}},11:{name:"forest",neighbours:[10,12],conditional:{use_raft:[32,33]},center:{x:4275,y:1980}},12:{name:"fields",neighbours:[11,13],conditional:{use_raft:[33]},center:{x:4275,y:2350}},13:{name:"village",neighbours:[12,14],conditional:{use_raft:[33]},center:{x:4200,y:2750}},14:{name:"fields",neighbours:[13,15],conditional:{use_raft:[33,34]},center:{x:3575,y:2760}},15:{name:"graveyard",neighbours:[14,16],conditional:{use_raft:[34,35]},center:{x:2925,y:2760}},16:{name:"woods",neighbours:[15,17],conditional:{use_raft:[35]},center:{x:2255,y:2760}},17:{name:"sentinel",neighbours:[16,18],conditional:{defeat_sentinel:36,use_raft:[36,35]},center:{x:1650,y:2760}},18:{name:"hills",neighbours:[17,19],conditional:{use_raft:[36,37]},center:{x:1e3,y:2760}},19:{name:"chapel",neighbours:[18,20],conditional:{use_raft:[37]},center:{x:405,y:2740}},20:{name:"fields",neighbours:[19,21],conditional:{use_raft:[37]},center:{x:310,y:2355}},21:{name:"crags",neighbours:[20,22],conditional:{use_raft:[37,38]},center:{x:310,y:1940}},22:{name:"plains",neighbours:[21,23],conditional:{use_raft:[39,40]},center:{x:310,y:1535}},23:{name:"woods",neighbours:[22,24],conditional:{use_raft:[40,25]},center:{x:310,y:1110}},24:{name:"fields",neighbours:[23,1],conditional:{use_raft:[25]},center:{x:310,y:700}},25:{name:"warlock's cave",neighbours:[26,40],conditional:{use_raft:[1,2,24]}},26:{name:"desert",neighbours:[25,26],conditional:{use_raft:[2,3]}},27:{name:"oasis",neighbours:[26,28],conditional:{use_raft:[3,4,5]}},28:{name:"desert",neighbours:[27,29],conditional:{use_raft:[5,6]}},29:{name:"temple",neighbours:[28,30],conditional:{use_raft:[6,7,8,9]}},30:{name:"woods",neighbours:[29,31],conditional:{use_raft:[9]}},31:{name:"runes",neighbours:[30,32],conditional:{use_raft:[9,10]}},32:{name:"castle",neighbours:[31,33],conditional:{use_raft:[10,11]}},33:{name:"portal_of_power",neighbours:[32,34],conditional:{portal_of_power:[48],use_raft:[12,13,14]}},34:{name:"black_knight",neighbours:[33,35],conditional:{use_raft:[14,15]}},35:{name:"hidden_valley",neighbours:[34,36],conditional:{use_raft:[15,16,17]}},36:{name:"hills",neighbours:[35,37],conditional:{use_raft:[17,18]}},37:{name:"cursed_glade",neighbours:[36,38],conditional:{use_raft:[18,19,20]}},38:{name:"runes",neighbours:[37,39],conditional:{use_raft:[21]}},39:{name:"chasm",neighbours:[38,40],conditional:{use_raft:[22]}},40:{name:"runes",neighbours:[39,25],conditional:{use_raft:[22,23]}},41:{name:"plain_of_peril",neighbours:[33,45,46]},42:{name:"mines",neighbours:[41,43]},43:{name:"vampire's tower",neighbours:[42,44]},44:{name:"pits",neighbours:[43],conditional:{has_talisman:[48]}},45:{name:"crypt",neighbours:[41,46]},46:{name:"dice_with_death",neighbours:[45,47]},47:{name:"werewolf_den",neighbours:[46,48]},48:{name:"valley of fire",neighbours:[44,47,49]},49:{name:"crown_of_command",neighbours:[48]},cols:7,rows:7};var Loader={images:{},loadImage:function(e,t,a=null){var i=new Image;console.log(a);var n=new Promise(function(a,n){i.onload=function(){this.images[e]=i,a(i)}.bind(this),i.onerror=function(){n("Could not load image: "+t)}}.bind(this));return i.src=t,null!==a&&(i.style.width=a.width+"px",i.style.height=a.height+"px",i.width=a.width,i.height=a.height),n},getImage:function(e){return e in this.images?this.images[e]:null}};class Board{constructor(){this.state={}}getCol(e){}}function Camera(e,t,a){this.x=0,this.y=0,this.width=t,this.height=a,this.maxX=e.state.width-t,this.maxY=e.state.height-a}Camera.prototype.follow=function(e){this.following=e,e.screenX=0,e.screenY=0},Camera.prototype.update=function(){this.following.screenX=this.width/2,this.following.screenY=this.height/2,this.x=this.following.x-this.width/2,this.y=this.following.y-this.height/2,this.x=Math.max(0,Math.min(this.x,this.maxX)),this.y=Math.max(0,Math.min(this.y,this.maxY)),(this.following.x<this.width/2||this.following.x>this.maxX+this.width/2)&&(this.following.screenX=this.following.x-this.x),(this.following.y<this.height/2||this.following.y>this.maxY+this.height/2)&&(this.following.screenY=this.following.y-this.y)};class Character{constructor(e,t,a,i,n,s="neutral"){this.state={name:e,type:"character",alignment:s,strength:t,craft:a,lives:i,fate:n,strengthMin:t,craftMin:a,livesMax:i,fateMax:n,spells:[],items:[],followers:[],carryLimit:4,cardDraw:1,curCard:null,cardsDrawn:[]}}update(){for(var e=0;e<this.state.items.length;e++)this.state.items[e].update()}drawCard(e=0){const t=e+this.state.cardDraw;console.log(`${this.state.name} has drawn ${t} card(s)`);for(var a=0;a<t;a++)this.state.cardsDrawn.push("Card #"+a)}discardCard(e){e.decks.discard.push(e)}addFollower(e){e.added(this),this.state.followers.push(e)}removeFollower(e){return e.removed(this)}useItem(e){return e.requirementUse(this)?(e.use(this),!0):(console.log(`${this.state.name} does not fulfill the requirements to use ${e.state.name}: ${e.state.requirement_text.use}`),!1)}addItem(e){return e.requirementPickup(this)?this.hasMaxItems()?(console.log(`${this.state.name} has too many items (${this.state.carryLimit}/${this.state.carryLimit})`),!1):(console.log(`${this.state.name} picked up ${e.state.name}`),e.added(this),this.state.items.push(e),!0):(console.log(`${this.state.name} does not fulfill the requirements of ${e.state.name}: ${e.state.requirement_text.pickup}`),!1)}removeItem(e){return e.removed(this)}drawSpell(){this.state.spells.push("a new Spell"),console.log(this.state.name+" drew a new Spell")}addSpell(e){this.state.spells.push(e),console.log(`${this.state.name} drew ${e}`)}useSpell(e,t=null){return this.state.spells=[],!!castSpell(this,e,t)}spellCount(){return this.state.spells.length}hasMaxSpells(){return Math.floor(this.state.craft/2)<=this.spellCount()}hasMaxItems(){return this.state.itemMax<=this.state.items.length}}class Entity{constructor(e,t,a=null){this.state={name:e,type:t,owner:a,requirement_text:{use:"",pickup:""}}}update(){}added(e){this.state.owner=e}removed(){this.state.owner=null}use(e,t=null){console.log`${e.state.name} used ${this.state.name}`}requirementUse(e){return!0}requirementPickup(e){return!0}}var Game={};function drawSpell(e){e.hasMaxSpells()?console.log(e.state.name+" cannot draw a Spell: has max spells!"):e.addSpell("a new spell")}function castSpell(e,t,a=null){return e.state.spells.pop(),console.log(`${e.state.name} casts spell: ${t}!`),!0}function always_one_spell(e){let t=e.update.bind(e);return e.update=()=>{t(),"character"==e.state.type?0==e.state.spells.length&&e.drawSpell():0==e.state.owner.state.spells.length&&e.state.owner(drawSpell)},e}function may_discard_first_drawn_adventure_card(e){e.drawFn=e.drawCard.bind(e),e.drawCard=(t=0)=>{const a=e.state.cardDraw+t;for(var i=1;i<a+1;i++)console.log(`${e.state.name} has drawn ${i}/${a} card(s)`)}}function draw_extra_cards(e,t=1){e.added=e=>{addFn(e),e.state.cardDraw+=t};let a=e.removed.bind(e);e.removed=e=>{e.state.carryLimit-=t,a()}}function carry_limit_increase(e,t=4){let a=e.added.bind(e);e.added=e=>{a(e);for(var i=document.getElementById("inventory").getElementsByTagName("tbody")[0],n=document.createElement("tr"),s=e.state.carryLimit+1;s-1<e.state.carryLimit+t;s++){var r=document.createElement("td");r.id="i"+s,r.setAttribute("class","slot"),n.appendChild(r),s%4==0&&(i.appendChild(n),n=document.createElement("tr"))}e.state.carryLimit+=t};let i=e.removed.bind(e);return e.removed=e=>{for(var a=document.getElementById("inventory").getElementsByTagName("tbody")[0],n=0;n<t/4;n++)a.deleteRow(a.rows-n);e.state.carryLimit-=t,i()},e}function discard_on_remove(e){let t=e.removed.bind(e);return e.removed=()=>(t(),!1),e}function required_alignment_to_use(e,t,a=!1){let i=e.requirementUse.bind(e);return e.state.requirement_text.use=`no ${t} characters can use this ${e.state.type}`,e.requirementUse=e=>e.state.alignment===t!==a&&i(),e}function required_alignment_to_pickup(e,t,a=!1){let i=e.requirementPickup.bind(e);return e.state.requirement_text.pickup=`no ${t} characters can have this ${e.state.type}`,e.requirementPickup=e=>e.state.alignment===t!==a&&i(),e}Game.run=function(e){this.ctx=e,this._previousElapsed=0;var t=this.load();Promise.all(t).then(function(e){this.init(),window.requestAnimationFrame(this.tick)}.bind(this))},Game.tick=function(e){window.requestAnimationFrame(this.tick),this.ctx.clearRect(0,0,512,512);var t=(e-this._previousElapsed)/1e3;t=Math.min(t,.25),this._previousElapsed=e,this.update(t),this.render()}.bind(Game),Game.init=function(){},Game.update=function(e){},Game.render=function(){},window.onload=function(){var e=document.getElementById("demo").getContext("2d");Game.run(e)};const required_alignment_to_pickup_NOT=(e,t)=>required_alignment_to_pickup(e,t,!0),required_alignment_to_use_NOT=(e,t)=>required_alignment_to_use(e,t,!0);var Keyboard={LEFT:37,RIGHT:39,UP:38,DOWN:40,_keys:{},listenForEvents:function(e){window.addEventListener("keydown",this._onKeyDown.bind(this)),window.addEventListener("keyup",this._onKeyUp.bind(this)),e.forEach(function(e){this._keys[e]=!1}.bind(this))},_onKeyDown:function(e){var t=e.keyCode;t in this._keys&&(e.preventDefault(),this._keys[t]=!0)},_onKeyUp:function(e){var t=e.keyCode;t in this._keys&&(e.preventDefault(),this._keys[t]=!1)},isDown:function(e){if(!e in this._keys)throw new Error("Keycode "+e+" is not being listened to");return this._keys[e]}};class Map{constructor(){this.state={image:Loader.getImage("talisman_board"),width:968.8830138797091,height:640,tsize:640/7,cols:7,rows:7}}}function Hero(e,t,a){this.map=e,this.x=t,this.y=a,this.width=e.state.tsize,this.height=e.state.tsize,this.image=Loader.getImage("hero")}Hero.SPEED=256,Hero.prototype.move=function(e,t,a){this.x+=t*Hero.SPEED*e,this.y+=a*Hero.SPEED*e;var i=this.map.state.width,n=this.map.state.height;this.x=Math.max(0,Math.min(this.x,i)),this.y=Math.max(0,Math.min(this.y,n))},Game.load=function(){return[Loader.loadImage("tiles","../assets/tiles.png"),Loader.loadImage("hero","../assets/prophetess.png",{width:96,height:96}),Loader.loadImage("talisman_board","../assets/talisman_board_hr.jpg")]},Game.init=function(){Keyboard.listenForEvents([Keyboard.LEFT,Keyboard.RIGHT,Keyboard.UP,Keyboard.DOWN]),this.tileAtlas=Loader.getImage("tiles"),this.map=new Map,this.hero=new Hero(this.map,96,96);this.camera=new Camera(this.map,1*this.map.state.width,1*this.map.state.height),this.camera.follow(this.hero)},Game.update=function(e){var t=0,a=0;Keyboard.isDown(Keyboard.LEFT)?t=-1:Keyboard.isDown(Keyboard.RIGHT)?t=1:Keyboard.isDown(Keyboard.UP)?a=-1:Keyboard.isDown(Keyboard.DOWN)&&(a=1),this.hero.move(e,t,a),this.camera.update()},Game._drawLayer=function(e){for(var t=Math.floor(this.camera.x/map.tsize),a=t+this.camera.width/map.tsize,i=Math.floor(this.camera.y/map.tsize),n=i+this.camera.height/map.tsize,s=-this.camera.x+t*map.tsize,r=-this.camera.y+i*map.tsize,o=t;o<=a;o++)for(var l=i;l<=n;l++){var h=map.getTile(e,o,l),d=(o-t)*map.tsize+s,m=(l-i)*map.tsize+r;0!==h&&this.ctx.drawImage(this.tileAtlas,(h-1)*map.tsize,0,map.tsize,map.tsize,Math.round(d),Math.round(m),map.tsize,map.tsize)}},Game._drawMap=function(){this.ctx.drawImage(this.map.state.image,-this.camera.x,-this.camera.y,this.map.state.width,this.map.state.height)},Game.render=function(){this._drawMap(),this.ctx.drawImage(this.hero.image,this.hero.screenX-this.hero.width/2,this.hero.screenY-this.hero.height/2,this.hero.image.width,this.hero.image.height)},window.onload=function(){var e=document.getElementById("demo").getContext("2d");Game.run(e)};class Prophetess extends Character{constructor(){super("Prophetess",2,4,4,2,"good"),always_one_spell(this),may_discard_first_drawn_adventure_card(this)}}var p=new Prophetess;p.update();var crystal_ball=new Entity("crystal_ball","magical_item");always_one_spell(crystal_ball);var mule=new Entity("mule","follower");carry_limit_increase(mule,4);var horse_and_carts=new Entity("horse_and_carts","follower");carry_limit_increase(horse_and_carts,8);var holy_grail=new Entity("holy_grail","magical_item");required_alignment_to_pickup(holy_grail,"good");var rune_sword=new Entity("rune_sword","magical_weapon");required_alignment_to_use_NOT(rune_sword,"good"),p.useSpell("Random"),p.update(),p.addItem(holy_grail),p.addItem(rune_sword),p.useItem(rune_sword),p.addItem(crystal_ball),p.update(),p.addItem(mule),p.update(),p.drawCard(),console.log(p.state.carryLimit);const SIDES=6;function rollDice(e,t=6){var a=0;for(i=1;i<=e;i++)a+=Math.floor(Math.random()*t+1);return a}const d3d6=()=>rollDice(3,6);function skillCheck(e,t=2){return e.value-rollDice(t)}